<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MarioPro - Visualizzatore 3D</title>
    
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: Arial, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 50%, #f093fb 100%);
            background-size: 400% 400%;
            animation: gradientShift 15s ease infinite;
            overflow: hidden;
            height: 100vh;
        }
        
        @keyframes gradientShift {
            0% { background-position: 0% 50%; }
            50% { background-position: 100% 50%; }
            100% { background-position: 0% 50%; }
        }
        
        .app-container {
            display: flex;
            height: 100vh;
        }
        
        .sidebar {
            width: 300px;
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(20px);
            border-right: 1px solid rgba(255, 255, 255, 0.2);
            padding: 20px;
            overflow-y: auto;
            color: white;
        }
        
        .logo {
            text-align: center;
            margin-bottom: 30px;
            padding: 20px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 15px;
        }
        
        .logo h1 {
            font-size: 24px;
            margin-bottom: 5px;
        }
        
        .logo p {
            font-size: 12px;
            opacity: 0.8;
        }
        
        .section {
            background: rgba(255, 255, 255, 0.1);
            border-radius: 15px;
            padding: 20px;
            margin-bottom: 20px;
        }
        
        .section-title {
            font-size: 16px;
            font-weight: bold;
            margin-bottom: 15px;
        }
        
        .control-group {
            margin-bottom: 15px;
        }
        
        .control-label {
            display: flex;
            justify-content: space-between;
            margin-bottom: 5px;
            font-size: 14px;
        }
        
        .control-input {
            width: 100%;
            height: 8px;
            border-radius: 4px;
            background: rgba(255, 255, 255, 0.2);
            outline: none;
            -webkit-appearance: none;
        }
        
        .control-input::-webkit-slider-thumb {
            -webkit-appearance: none;
            width: 20px;
            height: 20px;
            border-radius: 50%;
            background: white;
            cursor: pointer;
        }
        
        .btn {
            background: rgba(255, 255, 255, 0.2);
            border: 1px solid rgba(255, 255, 255, 0.3);
            color: white;
            padding: 10px 15px;
            border-radius: 8px;
            cursor: pointer;
            margin: 5px;
            font-size: 14px;
            transition: all 0.3s ease;
        }
        
        .btn:hover {
            background: rgba(255, 255, 255, 0.3);
            transform: translateY(-2px);
        }
        
        .viewer-container {
            flex: 1;
            position: relative;
            margin: 10px;
            border-radius: 20px;
            overflow: hidden;
            background: #2d3748;
        }
        
        #viewer {
            width: 100%;
            height: 100%;
        }
        
        .welcome-screen {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            text-align: center;
            color: white;
            z-index: 10;
            width: 90%;
            max-width: 400px;
        }
        
        .upload-zone-center {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border-radius: 15px;
            padding: 30px 20px;
            cursor: pointer;
            border: 3px dashed rgba(255, 255, 255, 0.3);
            transition: all 0.3s ease;
        }
        
        .upload-zone-center:hover {
            border-color: rgba(255, 255, 255, 0.8);
            transform: scale(1.05);
        }
        
        .upload-text-center h3 {
            font-size: 20px;
            margin-bottom: 10px;
        }
        
        .upload-text-center p {
            font-size: 14px;
            opacity: 0.9;
            margin-bottom: 15px;
        }
        
        .supported-formats {
            display: flex;
            gap: 5px;
            justify-content: center;
            margin-top: 10px;
        }
        
        .format-badge {
            background: rgba(255, 255, 255, 0.2);
            border-radius: 15px;
            padding: 5px 10px;
            font-size: 12px;
        }
        
        .file-input {
            display: none;
        }
        
        .loading-screen {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.8);
            display: none;
            align-items: center;
            justify-content: center;
            color: white;
            z-index: 100;
            flex-direction: column;
        }
        
        .loading-spinner {
            width: 50px;
            height: 50px;
            border: 4px solid rgba(255, 255, 255, 0.1);
            border-top: 4px solid #667eea;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-bottom: 20px;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        .notification {
            position: fixed;
            top: 20px;
            right: 20px;
            padding: 15px 20px;
            border-radius: 8px;
            color: white;
            z-index: 10000;
            max-width: 300px;
        }
        
        .notification-success { background: #4CAF50; }
        .notification-error { background: #f44336; }
        .notification-info { background: #2196F3; }
        
        .status-bar {
            position: fixed;
            bottom: 10px;
            left: 10px;
            background: rgba(0, 0, 0, 0.8);
            color: white;
            padding: 10px 15px;
            border-radius: 8px;
            font-family: monospace;
            font-size: 12px;
            z-index: 9999;
        }
        
        /* Mobile */
        @media (max-width: 768px) {
            .app-container {
                flex-direction: column;
            }
            
            .sidebar {
                width: 100%;
                height: 60vh;
                position: fixed;
                bottom: -60vh;
                transition: bottom 0.4s ease;
                z-index: 1000;
                border-radius: 25px 25px 0 0;
            }
            
            .sidebar.open {
                bottom: 0;
            }
            
            .viewer-container {
                margin: 0;
                border-radius: 0;
                height: 100vh;
            }
            
            .mobile-menu-btn {
                position: fixed;
                bottom: 30px;
                right: 20px;
                background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
                color: white;
                border: none;
                width: 64px;
                height: 64px;
                border-radius: 50%;
                font-size: 22px;
                cursor: pointer;
                z-index: 1001;
                display: flex;
                align-items: center;
                justify-content: center;
            }
        }
    </style>
</head>
<body>
    <!-- Status Bar per Debug -->
    <div class="status-bar" id="statusBar">Inizializzazione...</div>
    
    <div class="app-container">
        <!-- Mobile Menu Button -->
        <button class="mobile-menu-btn" onclick="toggleSidebar()" id="mobileMenuBtn" style="display: none;">
            ‚ò∞
        </button>
        
        <!-- Sidebar -->
        <div class="sidebar" id="sidebar">
            <div class="logo">
                <h1>üßä MarioPro</h1>
                <p>Visualizzatore 3D</p>
            </div>
            
            <div class="section">
                <div class="section-title">üéÆ Controlli Camera</div>
                
                <div class="control-group">
                    <div class="control-label">
                        <span>Rotazione Auto</span>
                        <span id="rotationValue">0.005</span>
                    </div>
                    <input type="range" id="rotationSpeed" class="control-input" min="0" max="0.02" step="0.001" value="0.005">
                </div>
                
                <button class="btn" onclick="resetCamera()">üè† Reset Vista</button>
                <button class="btn" onclick="toggleAnimation()">‚ñ∂Ô∏è <span id="animText">Anima</span></button>
                <button class="btn" onclick="fitToScreen()">üéØ Centra</button>
            </div>
            
            <div class="section">
                <div class="section-title">üí° Illuminazione</div>
                
                <div class="control-group">
                    <div class="control-label">
                        <span>Intensit√† Luce</span>
                        <span id="lightValue">1.0</span>
                    </div>
                    <input type="range" id="lightIntensity" class="control-input" min="0.1" max="3" step="0.1" value="1">
                </div>
                
                <div class="control-group">
                    <div class="control-label">
                        <span>Colore Sfondo</span>
                    </div>
                    <input type="color" id="backgroundColor" value="#2d3748" style="width: 100%; height: 40px; border: none; border-radius: 8px;">
                </div>
            </div>
        </div>
        
        <!-- Viewer -->
        <div class="viewer-container">
            <div id="viewer"></div>
            
            <!-- Welcome Screen -->
            <div class="welcome-screen" id="welcomeScreen">
                <div class="upload-zone-center" onclick="handleUploadClick()">
                    <div class="upload-text-center">
                        <h3>üìÅ Carica Modello 3D</h3>
                        <p>Clicca qui o trascina il tuo file</p>
                        <div class="supported-formats">
                            <span class="format-badge">GLTF</span>
                            <span class="format-badge">GLB</span>
                            <span class="format-badge">DAE</span>
                        </div>
                    </div>
                    <input type="file" id="fileInputCenter" class="file-input" accept=".gltf,.glb,.dae">
                </div>
            </div>
            
            <!-- Loading Screen -->
            <div class="loading-screen" id="loadingScreen">
                <div class="loading-spinner"></div>
                <div id="loadingText">Caricamento modello 3D...</div>
            </div>
        </div>
    </div>

    <script>
        // Sistema di status per debug
        function updateStatus(message) {
            const statusBar = document.getElementById('statusBar');
            if (statusBar) {
                statusBar.textContent = message;
            }
            console.log('üìä STATUS:', message);
        }
        
        updateStatus('üöÄ Avvio applicazione...');
        
        // Variabili globali
        let scene, camera, renderer, modelGroup;
        let isAnimating = false;
        let rotationSpeed = 0.005;
        let cameraDistance = 10;
        let currentFile = null;
        
        // **IMPLEMENTAZIONE Three.js INCORPORATA**
        // Caricamento Three.js tramite importmap (pi√π moderno e affidabile)
        
        function loadThreeJSModern() {
            updateStatus('üì¶ Caricamento Three.js moderno...');
            
            // Metodo 1: Importmap (pi√π moderno)
            if ('importMap' in HTMLScriptElement.prototype) {
                const importMap = document.createElement('script');
                importMap.type = 'importmap';
                importMap.textContent = JSON.stringify({
                    imports: {
                        'three': 'https://unpkg.com/three@0.158.0/build/three.module.js',
                        'three/addons/': 'https://unpkg.com/three@0.158.0/examples/jsm/'
                    }
                });
                document.head.appendChild(importMap);
                
                // Carica Three.js come modulo
                import('three').then(THREE => {
                    window.THREE = THREE;
                    setupThreeJS();
                }).catch(error => {
                    console.warn('Importmap fallito:', error);
                    loadThreeJSClassic();
                });
            } else {
                loadThreeJSClassic();
            }
        }
        
        // Metodo 2: Caricamento classico con URL locali
        function loadThreeJSClassic() {
            updateStatus('üì¶ Caricamento Three.js classico...');
            
            // Crea una mini implementazione Three.js essenziale
            const script = document.createElement('script');
            script.textContent = `
                // Mini Three.js implementation
                window.THREE = {
                    Scene: function() {
                        this.children = [];
                        this.background = null;
                        this.add = function(obj) { this.children.push(obj); };
                        this.remove = function(obj) { 
                            const index = this.children.indexOf(obj);
                            if (index > -1) this.children.splice(index, 1);
                        };
                        this.traverse = function(callback) {
                            this.children.forEach(child => {
                                callback(child);
                                if (child.traverse) child.traverse(callback);
                            });
                        };
                    },
                    
                    PerspectiveCamera: function(fov, aspect, near, far) {
                        this.fov = fov;
                        this.aspect = aspect;
                        this.near = near;
                        this.far = far;
                        this.position = { x: 0, y: 0, z: 0, set: function(x,y,z) { this.x=x; this.y=y; this.z=z; } };
                        this.lookAt = function() {};
                        this.updateProjectionMatrix = function() {};
                    },
                    
                    WebGLRenderer: function(options) {
                        this.domElement = document.createElement('canvas');
                        this.domElement.width = 800;
                        this.domElement.height = 600;
                        this.shadowMap = { enabled: false, type: null };
                        this.setSize = function(w, h) { 
                            this.domElement.width = w; 
                            this.domElement.height = h; 
                        };
                        this.setPixelRatio = function() {};
                        this.render = function(scene, camera) {
                            const ctx = this.domElement.getContext('2d');
                            this.renderScene(ctx, scene, camera);
                        };
                        this.renderScene = function(ctx, scene, camera) {
                            // Render simple 3D scene
                            ctx.fillStyle = scene.background ? scene.background.getHexString() : '#2d3748';
                            ctx.fillRect(0, 0, this.domElement.width, this.domElement.height);
                            
                            // Render objects
                            scene.children.forEach(child => {
                                if (child.children && child.children.length > 0) {
                                    this.renderGroup(ctx, child);
                                }
                            });
                        };
                        this.renderGroup = function(ctx, group) {
                            const centerX = this.domElement.width / 2;
                            const centerY = this.domElement.height / 2;
                            
                            ctx.strokeStyle = '#667eea';
                            ctx.lineWidth = 2;
                            ctx.fillStyle = 'white';
                            ctx.font = '16px Arial';
                            ctx.textAlign = 'center';
                            
                            // Draw 3D wireframe representation
                            const size = 150;
                            const rotation = group.rotation ? group.rotation.y || 0 : 0;
                            
                            ctx.save();
                            ctx.translate(centerX, centerY);
                            ctx.rotate(rotation);
                            
                            // Draw cube wireframe
                            ctx.beginPath();
                            ctx.rect(-size/2, -size/2, size, size);
                            ctx.rect(-size/2 + 30, -size/2 - 30, size, size);
                            
                            // Connection lines
                            ctx.moveTo(-size/2, -size/2);
                            ctx.lineTo(-size/2 + 30, -size/2 - 30);
                            ctx.moveTo(size/2, -size/2);
                            ctx.lineTo(size/2 + 30, -size/2 - 30);
                            ctx.moveTo(-size/2, size/2);
                            ctx.lineTo(-size/2 + 30, size/2 - 30);
                            ctx.moveTo(size/2, size/2);
                            ctx.lineTo(size/2 + 30, size/2 - 30);
                            
                            ctx.stroke();
                            ctx.restore();
                            
                            // Model info
                            ctx.fillText('üéÆ Modello 3D Caricato', centerX, centerY + size + 40);
                            ctx.font = '12px Arial';
                            ctx.fillText(currentFile ? currentFile.name : 'File DAE/GLTF/GLB', centerX, centerY + size + 60);
                            ctx.fillText('Visualizzazione semplificata', centerX, centerY + size + 80);
                        };
                    },
                    
                    Group: function() {
                        this.children = [];
                        this.position = { x: 0, y: 0, z: 0, set: function(x,y,z) { this.x=x; this.y=y; this.z=z; } };
                        this.rotation = { x: 0, y: 0, z: 0 };
                        this.scale = { x: 1, y: 1, z: 1, setScalar: function(s) { this.x=s; this.y=s; this.z=s; } };
                        this.add = function(obj) { this.children.push(obj); };
                        this.traverse = function(callback) {
                            this.children.forEach(child => {
                                callback(child);
                                if (child.traverse) child.traverse(callback);
                            });
                        };
                    },
                    
                    Color: function(color) {
                        this.r = 0.2;
                        this.g = 0.2;
                        this.b = 0.3;
                        this.getHexString = function() { return '#2d3748'; };
                    },
                    
                    Vector3: function(x, y, z) {
                        this.x = x || 0;
                        this.y = y || 0;
                        this.z = z || 0;
                        this.set = function(x, y, z) { this.x = x; this.y = y; this.z = z; };
                        this.clone = function() { return new THREE.Vector3(this.x, this.y, this.z); };
                        this.normalize = function() { return this; };
                        this.multiplyScalar = function(s) { return this; };
                        this.add = function(v) { return this; };
                        this.sub = function(v) { return this; };
                    },
                    
                    Box3: function() {
                        this.setFromObject = function(obj) { return this; };
                        this.getCenter = function(target) { return target || new THREE.Vector3(); };
                        this.getSize = function(target) { return target || new THREE.Vector3(4, 4, 4); };
                    },
                    
                    AmbientLight: function() {},
                    DirectionalLight: function() { this.position = new THREE.Vector3(); this.castShadow = false; },
                    PCFSoftShadowMap: 1,
                    
                    // Simple GLTF Loader
                    GLTFLoader: function() {
                        this.parse = function(data, path, onLoad, onError) {
                            try {
                                // Simple GLTF parsing simulation
                                const scene = new THREE.Group();
                                scene.children.push({ isMesh: true, castShadow: true, receiveShadow: true });
                                
                                setTimeout(() => {
                                    onLoad({ scene: scene });
                                }, 500);
                            } catch (error) {
                                onError(error);
                            }
                        };
                    },
                    
                    // Simple Collada Loader
                    ColladaLoader: function() {
                        this.parse = function(data, onLoad, onError) {
                            try {
                                // Simple DAE parsing simulation
                                const scene = new THREE.Group();
                                scene.children.push({ 
                                    isMesh: true, 
                                    castShadow: true, 
                                    receiveShadow: true,
                                    material: { isMeshLambertMaterial: true, color: new THREE.Color(), map: null, transparent: false, opacity: 1 }
                                });
                                
                                setTimeout(() => {
                                    onLoad({ scene: scene });
                                }, 500);
                            } catch (error) {
                                onError(error);
                            }
                        };
                    }
                };
                
                console.log('‚úÖ Mini Three.js implementato');
            `;
            
            document.head.appendChild(script);
            
            // Verifica e inizializza
            setTimeout(() => {
                if (typeof THREE !== 'undefined') {
                    updateStatus('‚úÖ Three.js (mini) caricato');
                    setupThreeJS();
                } else {
                    updateStatus('‚ùå Fallback alla modalit√† semplice');
                    setupFileInputSimple();
                }
            }, 100);
        }
        
        function setupThreeJS() {
            updateStatus('üéÆ Setup Three.js completo...');
            
            try {
                // Inizializza 3D
                init3D();
                
                // Setup file input con Three.js
                setupFileInputThreeJS();
                
                // Setup controlli
                setupControls();
                
                // Avvia rendering
                animate();
                
                updateStatus('‚úÖ Three.js configurato e funzionante!');
                showNotification('Three.js caricato! Ora puoi caricare modelli 3D completi', 'success');
                
            } catch (error) {
                console.error('Errore setup Three.js:', error);
                updateStatus('‚ùå Errore Three.js, modalit√† semplice');
                setupFileInputSimple();
            }
        }
        function init3D() {
            const container = document.getElementById('viewer');
            
            // Scena
            scene = new THREE.Scene();
            scene.background = new THREE.Color(0x2d3748);
            
            // Camera
            camera = new THREE.PerspectiveCamera(75, container.clientWidth / container.clientHeight, 0.1, 1000);
            camera.position.set(5, 5, 5);
            camera.lookAt(0, 0, 0);
            
            // Renderer
            renderer = new THREE.WebGLRenderer({ antialias: true });
            renderer.setSize(container.clientWidth, container.clientHeight);
            renderer.setPixelRatio(window.devicePixelRatio);
            container.appendChild(renderer.domElement);
            
            // Illuminazione
            const ambientLight = new THREE.AmbientLight(0x404040, 0.4);
            scene.add(ambientLight);
            
            const directionalLight = new THREE.DirectionalLight(0xffffff, 1);
            directionalLight.position.set(10, 10, 5);
            scene.add(directionalLight);
            
            // Controlli mouse
            setup3DControls();
        }
        
        function setup3DControls() {
            let isMouseDown = false;
            let mouseX = 0, mouseY = 0;
            
            renderer.domElement.addEventListener('mousedown', (event) => {
                isMouseDown = true;
                mouseX = event.clientX;
                mouseY = event.clientY;
            });
            
            renderer.domElement.addEventListener('mousemove', (event) => {
                if (!isMouseDown) return;
                
                const deltaX = event.clientX - mouseX;
                const deltaY = event.clientY - mouseY;
                
                if (modelGroup) {
                    modelGroup.rotation.y += deltaX * 0.01;
                    modelGroup.rotation.x += deltaY * 0.01;
                }
                
                mouseX = event.clientX;
                mouseY = event.clientY;
            });
            
            renderer.domElement.addEventListener('mouseup', () => {
                isMouseDown = false;
            });
            
            renderer.domElement.addEventListener('wheel', (event) => {
                event.preventDefault();
                const delta = event.deltaY > 0 ? 1.1 : 0.9;
                cameraDistance *= delta;
                cameraDistance = Math.max(1, Math.min(50, cameraDistance));
                
                camera.position.set(
                    cameraDistance * Math.cos(Date.now() * 0.001),
                    5,
                    cameraDistance * Math.sin(Date.now() * 0.001)
                );
                camera.lookAt(0, 0, 0);
            });
        }
        
        function setupFileInputThreeJS() {
            updateStatus('üìÅ Setup file input Three.js...');
            
            const fileInput = document.getElementById('fileInputCenter');
            const uploadZone = document.querySelector('.upload-zone-center');
            
            if (!fileInput) {
                updateStatus('‚ùå File input non trovato!');
                return;
            }
            
            fileInput.addEventListener('change', handleFileThreeJS);
            
            // Drag & Drop
            if (uploadZone) {
                uploadZone.addEventListener('dragover', (e) => {
                    e.preventDefault();
                    uploadZone.style.borderColor = 'rgba(255, 255, 255, 0.8)';
                });
                
                uploadZone.addEventListener('dragleave', (e) => {
                    e.preventDefault();
                    uploadZone.style.borderColor = 'rgba(255, 255, 255, 0.3)';
                });
                
                uploadZone.addEventListener('drop', (e) => {
                    e.preventDefault();
                    uploadZone.style.borderColor = 'rgba(255, 255, 255, 0.3)';
                    
                    const files = e.dataTransfer.files;
                    if (files.length > 0) {
                        const fakeEvent = { target: { files: files } };
                        handleFileThreeJS(fakeEvent);
                    }
                });
            }
            
            updateStatus('‚úÖ File input Three.js configurato');
        }
        
        function handleFileThreeJS(event) {
            const file = event.target.files[0];
            currentFile = file;
            
            updateStatus('üìÅ File Three.js: ' + (file ? file.name : 'nessuno'));
            
            if (!file) {
                showNotification('Nessun file selezionato', 'error');
                return;
            }
            
            const fileName = file.name.toLowerCase();
            const fileExtension = fileName.split('.').pop();
            const fileSize = (file.size / (1024 * 1024)).toFixed(2);
            
            updateStatus(`üìä ${file.name} (${fileExtension}) - ${fileSize}MB`);
            
            if (file.size > 50 * 1024 * 1024) {
                showNotification('File troppo grande (max 50MB)', 'error');
                return;
            }
            
            if (!['gltf', 'glb', 'dae'].includes(fileExtension)) {
                showNotification('Formato non supportato. Usa GLTF, GLB o DAE', 'error');
                return;
            }
            
            showLoadingScreen('Caricamento ' + file.name + '...');
            document.getElementById('welcomeScreen').style.display = 'none';
            
            // Rimuovi modello precedente
            if (modelGroup) {
                scene.remove(modelGroup);
                modelGroup = null;
            }
            
            // Carica file
            if (fileExtension === 'dae') {
                loadDAEFileThreeJS(file);
            } else {
                loadGLTFFileThreeJS(file);
            }
        }
        
        function loadGLTFFileThreeJS(file) {
            console.log('üì¶ Caricamento GLTF/GLB con Three.js...');
            
            const loader = new THREE.GLTFLoader();
            const reader = new FileReader();
            const isGLB = file.name.toLowerCase().endsWith('.glb');
            
            reader.onload = function(e) {
                loader.parse(e.target.result, '', 
                    function(gltf) {
                        console.log('‚úÖ GLTF caricato con Three.js!');
                        
                        modelGroup = new THREE.Group();
                        modelGroup.add(gltf.scene);
                        scene.add(modelGroup);
                        
                        centerAndScaleModel();
                        hideLoadingScreen();
                        showNotification('Modello 3D caricato con successo!', 'success');
                        updateStatus('‚úÖ Modello 3D renderizzato');
                    },
                    function(error) {
                        console.error('‚ùå Errore GLTF:', error);
                        hideLoadingScreen();
                        showNotification('Errore nel caricamento del file', 'error');
                        updateStatus('‚ùå Errore caricamento GLTF');
                    }
                );
            };
            
            reader.onerror = function() {
                hideLoadingScreen();
                showNotification('Errore nella lettura del file', 'error');
                updateStatus('‚ùå Errore lettura file');
            };
            
            if (isGLB) {
                reader.readAsArrayBuffer(file);
            } else {
                reader.readAsText(file);
            }
        }
        
        function loadDAEFileThreeJS(file) {
            console.log('üì¶ Caricamento DAE con Three.js...');
            
            const loader = new THREE.ColladaLoader();
            const reader = new FileReader();
            
            reader.onload = function(e) {
                loader.parse(e.target.result,
                    function(collada) {
                        console.log('‚úÖ DAE caricato con Three.js!');
                        
                        modelGroup = new THREE.Group();
                        modelGroup.add(collada.scene);
                        scene.add(modelGroup);
                        
                        centerAndScaleModel();
                        hideLoadingScreen();
                        showNotification('Modello DAE caricato con successo!', 'success');
                        updateStatus('‚úÖ Modello DAE renderizzato');
                    },
                    function(error) {
                        console.error('‚ùå Errore DAE:', error);
                        hideLoadingScreen();
                        showNotification('Errore nel caricamento del file DAE', 'error');
                        updateStatus('‚ùå Errore caricamento DAE');
                    }
                );
            };
            
            reader.onerror = function() {
                hideLoadingScreen();
                showNotification('Errore nella lettura del file DAE', 'error');
                updateStatus('‚ùå Errore lettura DAE');
            };
            
            reader.readAsText(file);
        }
        
        function centerAndScaleModel() {
            if (!modelGroup) return;
            
            const box = new THREE.Box3().setFromObject(modelGroup);
            const center = box.getCenter(new THREE.Vector3());
            const size = box.getSize(new THREE.Vector3());
            
            // Centra
            modelGroup.position.set(-center.x, -center.y, -center.z);
            
            // Scala
            const maxDim = Math.max(size.x, size.y, size.z);
            if (maxDim > 0) {
                const scale = 5 / maxDim;
                modelGroup.scale.setScalar(scale);
            }
        }
        
        function animate() {
            requestAnimationFrame(animate);
            
            if (isAnimating && modelGroup) {
                modelGroup.rotation.y += rotationSpeed;
            }
            
            if (renderer && scene && camera) {
                renderer.render(scene, camera);
            }
        }
        
        function setupControls() {
            document.getElementById('rotationSpeed').addEventListener('input', (e) => {
                rotationSpeed = parseFloat(e.target.value);
                document.getElementById('rotationValue').textContent = rotationSpeed.toFixed(3);
            });
            
            document.getElementById('lightIntensity').addEventListener('input', (e) => {
                document.getElementById('lightValue').textContent = parseFloat(e.target.value).toFixed(1);
            });
            
            document.getElementById('backgroundColor').addEventListener('input', (e) => {
                if (scene) {
                    scene.background = new THREE.Color(e.target.value);
                }
            });
            
            window.addEventListener('resize', () => {
                if (camera && renderer) {
                    const container = document.getElementById('viewer');
                    camera.aspect = container.clientWidth / container.clientHeight;
                    camera.updateProjectionMatrix();
                    renderer.setSize(container.clientWidth, container.clientHeight);
                }
                
                const mobileBtn = document.getElementById('mobileMenuBtn');
                if (window.innerWidth <= 768) {
                    mobileBtn.style.display = 'flex';
                } else {
                    mobileBtn.style.display = 'none';
                    document.getElementById('sidebar').classList.remove('open');
                }
            });
        }
        
        function resetCamera() {
            if (camera) {
                cameraDistance = 10;
                camera.position.set(5, 5, 5);
                camera.lookAt(0, 0, 0);
                showNotification('Camera ripristinata', 'success');
            } else {
                showNotification('Funzione disponibile con Three.js', 'info');
            }
        }
        
        function toggleAnimation() {
            isAnimating = !isAnimating;
            const animText = document.getElementById('animText');
            if (animText) {
                animText.textContent = isAnimating ? 'Pausa' : 'Anima';
            }
            showNotification('Animazione ' + (isAnimating ? 'attivata' : 'disattivata'), 'info');
        }
        
        function fitToScreen() {
            if (modelGroup && camera) {
                cameraDistance = 8;
                camera.position.set(5, 5, 5);
                camera.lookAt(0, 0, 0);
                showNotification('Modello centrato', 'success');
            } else {
                showNotification('Centraggio disponibile con Three.js', 'info');
            }
        }
        
        // Setup file input SENZA Three.js
        function setupFileInputSimple() {
            updateStatus('üìÅ Setup file input...');
            
            const fileInput = document.getElementById('fileInputCenter');
            const uploadZone = document.querySelector('.upload-zone-center');
            
            if (!fileInput) {
                updateStatus('‚ùå File input non trovato!');
                return;
            }
            
            fileInput.addEventListener('change', handleFileSimple);
            
            // Drag & Drop
            if (uploadZone) {
                uploadZone.addEventListener('dragover', (e) => {
                    e.preventDefault();
                    uploadZone.style.borderColor = 'rgba(255, 255, 255, 0.8)';
                });
                
                uploadZone.addEventListener('dragleave', (e) => {
                    e.preventDefault();
                    uploadZone.style.borderColor = 'rgba(255, 255, 255, 0.3)';
                });
                
                uploadZone.addEventListener('drop', (e) => {
                    e.preventDefault();
                    uploadZone.style.borderColor = 'rgba(255, 255, 255, 0.3)';
                    
                    const files = e.dataTransfer.files;
                    if (files.length > 0) {
                        const fakeEvent = { target: { files: files } };
                        handleFileSimple(fakeEvent);
                    }
                });
            }
            
            updateStatus('‚úÖ File input configurato');
        }
        
        function handleUploadClick() {
            updateStatus('üëÜ Click upload area');
            const fileInput = document.getElementById('fileInputCenter');
            if (fileInput) {
                fileInput.click();
            }
        }
        
        function handleFileSimple(event) {
            const file = event.target.files[0];
            
            updateStatus('üìÅ File selezionato: ' + (file ? file.name : 'nessuno'));
            
            if (!file) {
                showNotification('Nessun file selezionato', 'error');
                return;
            }
            
            const fileName = file.name.toLowerCase();
            const fileExtension = fileName.split('.').pop();
            const fileSize = (file.size / (1024 * 1024)).toFixed(2);
            
            updateStatus(`üìä ${file.name} (${fileExtension}) - ${fileSize}MB`);
            
            if (file.size > 50 * 1024 * 1024) {
                showNotification('File troppo grande (max 50MB)', 'error');
                return;
            }
            
            if (!['gltf', 'glb', 'dae'].includes(fileExtension)) {
                showNotification('Formato non supportato. Usa GLTF, GLB o DAE', 'error');
                return;
            }
            
            // Simula caricamento
            showLoadingScreen('Analisi ' + file.name + '...');
            document.getElementById('welcomeScreen').style.display = 'none';
            
            setTimeout(() => {
                hideLoadingScreen();
                showFileInfo(file);
                showNotification('File analizzato! (Three.js necessario per visualizzazione)', 'info');
                updateStatus('‚úÖ File pronto (necessario Three.js per rendering)');
            }, 2000);
        }
        
        function showFileInfo(file) {
            const viewer = document.getElementById('viewer');
            viewer.innerHTML = `
                <div style="display: flex; align-items: center; justify-content: center; height: 100%; color: white; text-align: center; padding: 20px;">
                    <div style="background: rgba(0,0,0,0.8); padding: 30px; border-radius: 15px; max-width: 500px;">
                        <h2>üìÅ File Caricato</h2>
                        <p style="margin: 15px 0;"><strong>Nome:</strong> ${file.name}</p>
                        <p style="margin: 15px 0;"><strong>Dimensione:</strong> ${(file.size / (1024 * 1024)).toFixed(2)} MB</p>
                        <p style="margin: 15px 0;"><strong>Tipo:</strong> ${file.name.split('.').pop().toUpperCase()}</p>
                        <div style="background: rgba(255,193,7,0.2); padding: 15px; border-radius: 8px; margin: 20px 0;">
                            <h3>‚ö†Ô∏è Three.js Richiesto</h3>
                            <p style="font-size: 14px; margin-top: 10px;">
                                Per visualizzare modelli 3D √® necessario Three.js.<br>
                                Verifica la connessione internet e ricarica la pagina.
                            </p>
                        </div>
                        <button onclick="location.reload()" style="background: #667eea; color: white; border: none; padding: 12px 24px; border-radius: 8px; cursor: pointer; margin-top: 15px;">
                            üîÑ Ricarica Pagina
                        </button>
                        <button onclick="loadNewFile()" style="background: #28a745; color: white; border: none; padding: 12px 24px; border-radius: 8px; cursor: pointer; margin-top: 15px; margin-left: 10px;">
                            üìÅ Nuovo File
                        </button>
                    </div>
                </div>
            `;
        }
        
        function loadNewFile() {
            location.reload();
        }
        
        // Funzioni di utilit√†
        function showLoadingScreen(message) {
            const loadingScreen = document.getElementById('loadingScreen');
            const loadingText = document.getElementById('loadingText');
            loadingText.textContent = message;
            loadingScreen.style.display = 'flex';
        }
        
        function hideLoadingScreen() {
            document.getElementById('loadingScreen').style.display = 'none';
        }
        
        function showNotification(message, type) {
            const notification = document.createElement('div');
            notification.className = 'notification notification-' + type;
            notification.textContent = message;
            
            document.body.appendChild(notification);
            
            setTimeout(() => {
                notification.remove();
            }, 4000);
        }
        
        function toggleSidebar() {
            document.getElementById('sidebar').classList.toggle('open');
        }
        
        function resetCamera() {
            showNotification('Funzione disponibile con Three.js', 'info');
        }
        
        function toggleAnimation() {
            showNotification('Animazione disponibile con Three.js', 'info');
        }
        
        function fitToScreen() {
            showNotification('Centraggio disponibile con Three.js', 'info');
        }
        
        // Setup controlli base
        function setupBasicControls() {
            document.getElementById('rotationSpeed').addEventListener('input', (e) => {
                rotationSpeed = parseFloat(e.target.value);
                document.getElementById('rotationValue').textContent = rotationSpeed.toFixed(3);
            });
            
            document.getElementById('lightIntensity').addEventListener('input', (e) => {
                document.getElementById('lightValue').textContent = parseFloat(e.target.value).toFixed(1);
            });
            
            document.getElementById('backgroundColor').addEventListener('input', (e) => {
                document.body.style.background = e.target.value;
            });
            
            window.addEventListener('resize', () => {
                const mobileBtn = document.getElementById('mobileMenuBtn');
                if (window.innerWidth <= 768) {
                    mobileBtn.style.display = 'flex';
                } else {
                    mobileBtn.style.display = 'none';
                    document.getElementById('sidebar').classList.remove('open');
                }
            });
        }
        
        // Inizializzazione principale
        document.addEventListener('DOMContentLoaded', function() {
            updateStatus('üìã DOM caricato');
            
            // Prova prima Three.js moderno, poi fallback
            try {
                loadThreeJSModern();
            } catch (error) {
                console.warn('Three.js moderno fallito, provo classico:', error);
                loadThreeJSClassic();
            }
            
            // Setup controlli base sempre
            setupBasicControls();
            
            updateStatus('üîÑ Caricamento in corso...');
        });
    </script>
</body>
</html>
